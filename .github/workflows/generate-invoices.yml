name: Generate Weekly Invoices

on:
  schedule:
    # Runs every Monday at 6 AM UTC
    - cron: '0 6 * * 1'

  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:
    inputs:
      start_date:
        description: 'Start date (YYYY-MM-DD) - optional'
        required: false
      end_date:
        description: 'End date (YYYY-MM-DD) - optional'
        required: false
      dry_run:
        description: 'Dry run only - do not create invoices (true/false)'
        required: false
        default: 'false'

jobs:
  generate-invoices:
    runs-on: ubuntu-latest

    steps:
      - name: Get enquiries needing invoices
        id: get-enquiries
        run: |
          BASE_URL="https://www.partysnap.co.uk"

          # Build date params
          PARAMS="dryRun=true"
          if [ -n "${{ github.event.inputs.start_date }}" ]; then
            PARAMS="${PARAMS}&startDate=${{ github.event.inputs.start_date }}"
          fi
          if [ -n "${{ github.event.inputs.end_date }}" ]; then
            PARAMS="${PARAMS}&endDate=${{ github.event.inputs.end_date }}"
          fi

          echo "Fetching enquiries from: ${BASE_URL}/api/invoices/generate-batch?${PARAMS}"

          RESPONSE=$(curl -s "${BASE_URL}/api/invoices/generate-batch?${PARAMS}")
          echo "Response: $RESPONSE"

          # Extract enquiry IDs using jq
          ENQUIRY_IDS=$(echo "$RESPONSE" | jq -r '.enquiries[]?.enquiryId // empty' | tr '\n' ' ')
          COUNT=$(echo "$RESPONSE" | jq -r '.wouldGenerate // 0')

          echo "Found $COUNT enquiries needing invoices"
          echo "enquiry_ids=$ENQUIRY_IDS" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT

      - name: Generate invoices one by one
        if: steps.get-enquiries.outputs.count != '0' && github.event.inputs.dry_run != 'true'
        run: |
          BASE_URL="https://www.partysnap.co.uk"
          ENQUIRY_IDS="${{ steps.get-enquiries.outputs.enquiry_ids }}"

          SUCCESS=0
          FAILED=0

          for ID in $ENQUIRY_IDS; do
            echo "Generating invoice for enquiry: $ID"

            RESPONSE=$(curl -s -X POST "${BASE_URL}/api/invoices/generate" \
              -H "Content-Type: application/json" \
              -d "{\"enquiryId\": \"$ID\"}")

            # Check if successful
            if echo "$RESPONSE" | jq -e '.success == true' > /dev/null 2>&1; then
              INVOICE_NUM=$(echo "$RESPONSE" | jq -r '.results.success[0].invoiceNumber // "unknown"')
              echo "âœ… Created $INVOICE_NUM"
              SUCCESS=$((SUCCESS + 1))
            else
              echo "âŒ Failed: $RESPONSE"
              FAILED=$((FAILED + 1))
            fi

            # Small delay to avoid rate limiting
            sleep 1
          done

          echo ""
          echo "========================================"
          echo "Summary: $SUCCESS created, $FAILED failed"
          echo "========================================"

          # Save for summary
          echo "SUCCESS=$SUCCESS" >> $GITHUB_ENV
          echo "FAILED=$FAILED" >> $GITHUB_ENV

      - name: Dry run summary
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "ðŸ” DRY RUN - No invoices created"
          echo "Would generate ${{ steps.get-enquiries.outputs.count }} invoices"

      - name: Summary
        if: always()
        run: |
          echo "## Invoice Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "- **Type:** ${{ github.event_name == 'schedule' && 'Scheduled' || 'Manual' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Enquiries found:** ${{ steps.get-enquiries.outputs.count }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.dry_run }}" != "true" ]; then
            echo "- **Created:** ${SUCCESS:-0}" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed:** ${FAILED:-0}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Mode:** Dry run (no invoices created)" >> $GITHUB_STEP_SUMMARY
          fi
